# Руководство по настройке междоменных файлов cookie

В этом документе объясняется, как правильно настроить междоменные файлы cookie между серверной частью Render и интерфейсом Vercel.

## Проблема

Если ваш сервер размещен на Render, а интерфейс - на Vercel, вы можете столкнуться с проблемами, связанными с неправильной настройкой файлов cookie или их отправкой между доменами. Это связано с:

1. Ограничениями политики одного и того же источника в браузерах
2. Неправильной настройкой файлов cookie
3. Отсутствием заголовков CORS
4. Неправильные настройки домена

## Решение

Мы внесли несколько изменений, чтобы устранить эти проблемы:

1. Обновлена конфигурация файлов cookie для поддержки междоменного использования
2. Расширены настройки CORS, позволяющие использовать учетные данные
3. Добавлена правильная проверка домена
4. Реализовано подробное ведение журнала для отладки

## Переменные среды

Чтобы это работало, вам необходимо установить эти переменные среды в вашем развертывании рендеринга:

```
NODE_ENV=производственный
IS_RENDER=true
FRONTEND_DOMAIN=клиентский магазин трубопроводной арматуры.vercel.app
COOKIE_DOMAIN=клиентский магазин трубопроводной арматуры.vercel.app
CLIENT_URL=https://магазин трубопроводной арматуры-client.vercel.app
```

## Важные настройки файлов cookie

Для обеспечения работы междоменных файлов cookie:

1. Для параметра `SameSite" должно быть установлено значение "none"
2. Для параметра "secure" должно быть значение "true" (файлы cookie отправляются только по протоколу HTTPS)
3. Для параметра "domain" должен быть установлен ваш внешний домен
4. Серверная часть должна обслуживаться по протоколу HTTPS

## Отладка

Если у вас все еще возникают проблемы:

1. Проверьте журналы сервера на наличие подробной информации о файлах cookie
2. Убедитесь, что CORS настроен правильно
3. Убедитесь, что ваш интерфейс отправляет запросы с "учетными данными: "include""
4. Убедитесь, что оба сайта используют HTTPS
5. Убедитесь, что настройки домена точно совпадают

## Конфигурация внешнего интерфейса

Ваши запросы на выборку из внешнего интерфейса должны включать:

``javascript
извлекать('https://your-render-api.onrender.com/api/endpoint ', {
метод: 'POST',
учетные данные: 'include',
заголовки: _BOS_
"Content-Type": "приложение/json"
},
тело: JSON.stringify(данные)
})

```

Раздел "Учетные данные: "включить" имеет решающее значение для отправки файлов cookie с междоменными запросами.

## Тестирование

После внедрения этих изменений протестируйте процесс аутентификации:

1. Войдите в систему с действительными учетными данными
2. Проверьте файлы cookie вашего браузера, чтобы убедиться, что установлен токен обновления
3. Попробуйте обновить страницу, чтобы узнать, сохраняется ли состояние вашего входа в систему
4. Проверьте вкладку сеть на наличие ошибок CORS
```
